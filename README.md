# Overview

This README describes how to:

1. Set up a CockroachDB cluster using Docker Compose on single AWS EC2 instance.
2. Set up a multi-region cluster across two EC2 instances
3. Configure the cluster to process both transactional and analytical loads, i.e. OLTAP.


## Background

During the past 10 to 15 years, there has been a great application architecture shift away from a monolyth. The pursuit of higher scalability and reliability at a lower cost, inadvertantly or on purpose resulted in very large logical data sets spread over multiple data stores (databases). These data stores are usually de-coupled and/or contain redundant data. This side effect has evolved into a problem in and of its own. Here is an online post that talks about this effect in the insurance industry: [Inconsistent data practices](https://www.carriermanagement.com/brand-spotlight/vertafore/top-3-data-problems-insurance-carriers-face/)

A very typical use case is when the same data is being replicated from the database that supports transactional applications (OLTP) to a data warehouse for the analytical applicaitons (OLAP). With the amount of data generated by the modern applications and consumed by the Machine Learning models, the cost of maintaining two distinct systems and the data pipeline to replicate the data, this model may be getting a very expensive proposition. At the same time, the appetite for real-time analytics, such as recommendation engines or fraud detection, the pipeline time will become a real encumbrance.

A logical conclusion may be is to have a database engine that examplifies an OLTP-OLAP duality, capable of backing both transaction and analytical applicaiton simulteniously. CockroachDB, being a distributed engine with the multi-regionality features could very well be a great solutions.

## Installation

Our CockroachDB (CRDB) cluster will have 2 regions, `oltp` and `olap`, each residing on a separate AWS EC2 instance. This way, we can select an appropriate configuration (CPU, RAM and storage) for each side of the OLTP-OLAP paradigm.

The thrid EC2 instance will host:

- Sample transactional [application](https://github.com/aseriy/cockroach-demo)
- [`dbworkload`](https://github.com/fabiog1901/dbworkload) to simulate analytical workload
- [Grafana](https://grafana.com/) for performance visualization


## EC2 Instance 1


|  Tag                    | crdb-oltp          |              |
| :---------------------- | :----------------- | :----------- |
| Instance type           | `t2.xlarge`        |              |
|                         | vCPUs              |  `4`         |
|                         | RAM                |  `16G`       |
| OS                      | `Ubuntu 22.04`     |              |
| Volumes                 | `/dev/sda1`        |  `16GiB`     |
|                         | `/dev/xvdbb`       | `100GiB`     |


### Docker

https://docs.docker.com/engine/install/ubuntu/

```bash
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```


```bash
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

https://stackoverflow.com/questions/48957195/how-to-fix-docker-got-permission-denied-issue

```bash
sudo groupadd docker
sudo usermod -aG docker $USER
newgrp docker
docker run hello-world
reboot
```

### Set up `rsyslog`

TBD

Add the following line to the `/etc/hosts` file:

```bash
<EC2_Private_ID>	host.docker.internal
```

This will allow HAProxy running inside a Docker container, and possibly other containers, to send log messages to `rsyslog` running directly on the EC2 instance.


### Deploy CRDB Cluster

Create a directory for the cluster data.

```bash
mkdir -p /mnt/data/volumes
chown ubuntu:ubuntu /mnt/data/volumes
```


Clone this repository:

```bash
mkdir git
cd git
git clone https://github.com/aseriy/cockroachdb-sandbox
cd cockroachdb-sandbox
```

Create a symlink to the cluster data directory:

```bash
ln -s /mnt/data/volumes
```

```bash
$ ls -l
total 16
-rw-rw-r-- 1 ubuntu ubuntu  208 Sep 23 16:30 Dockerfile.haproxy
-rw-rw-r-- 1 ubuntu ubuntu 1612 Sep 23 16:30 README.md
-rw-rw-r-- 1 ubuntu ubuntu 2551 Sep 23 16:30 docker-compose.yml
-rw-rw-r-- 1 ubuntu ubuntu 1964 Sep 23 16:30 haproxy.cfg
lrwxrwxrwx 1 ubuntu ubuntu   17 Sep 23 16:11 volumes -> /mnt/data/volumes
```

[Docker Compose](https://docs.docker.com/compose/) is used to run the cluster with [HAProxy](https://www.haproxy.org/) as a load balancer.

Currently, `docker-compose.yml` will deploy six CRDB nodes.

>[!NOTE]
> There is a plan create a script to generate the `docker-compose.yml` with the specified number of CRDB nodes in the future. At the moment, you can edit this file manually to adjust the number of nodes to your requirements.

Start the cluster:

```bash
docker compose up -d
```

Once the cluster is up, you should be able open the admin console in a browser at

```bash
https://<EC2_IP>:8080
```

and check that all containers are up and running:

```bash
docker compose ps
```

or check the logs from any container:

```bash
docker compose logs -f roach0
```



## EC2 Instance 2


|  Tag                    | crdb-olap          |              |
| :---------------------- | :----------------- | :----------- |
| Instance type           | `t2.2xlarge`       |              |
|                         | vCPUs              |  `8`         |
|                         | RAM                |  `32G`       |
| OS                      | `Ubuntu 22.04`     |              |
| Volumes                 | `/dev/sda1`        |  `16GiB`     |
|                         | `/dev/xvdbb`       |  `100GiB`    |



## EC2 Instance 3


|  Tag                    | crdb-apps          |              |
| :---------------------- | :----------------- | :----------- |
| Instance type           | `t2.xlarge`        |              |
|                         | vCPUs              |  `4`         |
|                         | RAM                |  `16G`       |
| OS                      | `Ubuntu 22.04`     |              |
| Volumes                 | `/dev/sda1`        |  `16GiB`     |
|                         | `/dev/xvdbb`       | `100GiB`     |




Build Docker image for HSProxy:

```bash
docker build -f Dockerfile.haproxy -t roach-haproxy .
```

Docker Compose Install

```bash
sudo apt-get install docker-compose-plugin
docker compose version
```


Start

```bash
docker compose -f docker-compose.yml up --detach
```


Net tools aren't installed by default:

```bash
sudo apt install net-tools
```

